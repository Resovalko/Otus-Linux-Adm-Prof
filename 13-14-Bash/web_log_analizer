#!/bin/bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
LOG_FILE="/var/log/nginx/access.log"
LOCK_FILE="/tmp/cron_email_sender.lock"
EMAIL_RECEIVER="root"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–º–∞–Ω–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—á—Ç—ã
if command -v mail >/dev/null 2>&1; then
    MAIL_COMMAND="mail"
    echo "–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–∞ 'mail' –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º."
elif command -v sendmail >/dev/null 2>&1; then
    MAIL_COMMAND="sendmail"
    echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: 'mail' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è 'sendmail'."
else
    echo "–û—à–∏–±–∫–∞: –Ω–∏ 'mail', –Ω–∏ 'sendmail' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –Ω–∏—Ö —Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã:"
    echo "sudo apt install mailutils    # –î–ª—è mail"
    echo "–∏–ª–∏"
    echo "sudo apt install sendmail     # –î–ª—è sendmail"
    exit 1
fi

# –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
if [ -e "$LOCK_FILE" ]; then
    echo "–°–∫—Ä–∏–ø—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω."
    exit 1
fi

touch "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

# –í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
LAST_RUN_FILE="/tmp/cron_last_run_time"
NOW=$(date "+%Y-%m-%d %H:%M:%S")
if [ -f "$LAST_RUN_FILE" ]; then
    LAST_RUN=$(cat "$LAST_RUN_FILE")
else
    LAST_RUN=$(date -d "1 hour ago" "+%Y-%m-%d %H:%M:%S")
fi
echo "$NOW" > "$LAST_RUN_FILE"

# –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º, —á–∏—Ç–∞–µ–º—ã–º –≤—ã–≤–æ–¥–æ–º –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
TOP_IPS=$(awk -v last_run="$LAST_RUN" '$4 >= last_run {ip[$1]++} END {for (i in ip) printf("%-20s %d\n", i, ip[i])}' "$LOG_FILE" | sort -k2 -nr | awk 'BEGIN {printf("%-20s %s\n","IP-–∞–¥—Ä–µ—Å","–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤"); print "-------------------- -------------------"} {printf("%-20s %s\n", $1, $2)}' | head -10)

TOP_URLS=$(awk -v last_run="$LAST_RUN" '$4 >= last_run {url[$7]++} END {for (u in url) printf("%-50s %d\n", u, url[u])}' "$LOG_FILE" | sort -k2 -nr | awk 'BEGIN {printf("%-50s %s\n","URL","–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤"); print "-------------------------------------------------- -------------------"} {printf("%-50s %s\n", $1, $2)}' | head -10)

ERRORS=$(awk -v last_run="$LAST_RUN" '$4 >= last_run && ($9 ~ /^[45]/) {printf("[%s] %-15s %-50s %s\n", $4, $1, $7, $9)}' "$LOG_FILE" | sort)

HTTP_CODES=$(awk -v last_run="$LAST_RUN" '$4 >= last_run {codes[$9]++} END {for (c in codes) printf("%-10s %d\n", c, codes[c])}' "$LOG_FILE" | sort -k2 -nr | awk 'BEGIN {printf("%-10s %s\n","HTTP –ö–æ–¥","–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"); print "---------- ----------"} {printf("%-10s %d\n", $1, $2)}')

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏ —á–∏—Ç–∞–µ–º–æ–≥–æ –ø–∏—Å—å–º–∞
SUBJECT="–û—Ç—á–µ—Ç –∑–∞ $LAST_RUN - $NOW"
BODY="==================================================\n"
BODY+="üìä –û—Ç—á–µ—Ç –æ –≤–µ–±-—Ç—Ä–∞—Ñ–∏–∫–µ —Å $LAST_RUN –ø–æ $NOW\n"
BODY+="==================================================\n\n"
BODY+="üî• –¢–æ–ø 10 IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤:\n$TOP_IPS\n\n"
BODY+="üåê –¢–æ–ø 10 –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö URL:\n$TOP_URLS\n\n"
BODY+="üì• –°–≤–æ–¥–∫–∞ –∫–æ–¥–æ–≤ HTTP-–æ—Ç–≤–µ—Ç–æ–≤:\n$HTTP_CODES\n\n"
BODY+="‚ö†Ô∏è –û—à–∏–±–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–∫–æ–¥—ã 4xx –∏ 5xx):\n${ERRORS:-–ù–µ—Ç –æ—à–∏–±–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.}\n"
BODY+="==================================================\n"

# –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
if [ "$MAIL_COMMAND" = "mail" ]; then
    echo -e "$BODY" | mail -s "$SUBJECT" "$EMAIL_RECEIVER"
elif [ "$MAIL_COMMAND" = "sendmail" ]; then
    {
        echo "Subject: $SUBJECT"
        echo "To: $EMAIL_RECEIVER"
        echo -e "$BODY"
    } | sendmail -t
fi

if [ $? -eq 0 ]; then
    echo "–ü–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é $EMAIL_RECEIVER."
else
    echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å—å–º–∞. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (Postfix)."
fi

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø—Ä–æ–±–ª–µ–º –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–∏—Å–µ–º:
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –ø–∏—Å–µ–º: mailq
# - –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ): sudo postsuper -d ALL
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤: sudo tail -f /var/log/mail.log
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–∏–∞—Å–æ–≤: cat /etc/aliases | grep root (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤—ã–ø–æ–ª–Ω–∏—Ç—å: sudo newaliases)
# - –ß—Ç–µ–Ω–∏–µ –ø–æ—á—Ç—ã: mail
# - –ï—Å–ª–∏ mail –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç "No mail for root", —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∏—Å—å–º–∞ –Ω–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.
# - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Postfix: journalctl -u postfix –∏–ª–∏ tail -f /var/log/mail.log
# - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Postfix: postconf -n

# –ö–∞–∫ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∏—Å—å–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é root:
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω mailutils: sudo apt install mailutils
# 2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∏—Å—å–º–∞: mail
# 3. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–∏—Å–µ–º ‚Äî –≤–≤–µ–¥–∏—Ç–µ mail
# 4. –î–ª—è —á—Ç–µ–Ω–∏—è –ø–∏—Å—å–º–∞ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∏—Å—å–º–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter
# 5. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è ‚Äî d <–Ω–æ–º–µ—Ä_–ø–∏—Å—å–º–∞>, –∑–∞—Ç–µ–º Enter
# 6. –î–ª—è –≤—ã—Ö–æ–¥–∞ ‚Äî q

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron (–∫–∞–∂–¥—ã–π —á–∞—Å):
# crontab -e
# 0 * * * * /bin/bash /path/to/this_script.sh > /var/log/cron_email_sender.log 2>&1