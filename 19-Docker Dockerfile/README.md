# Docker Dockerfile

## Рабочее пространство
Система виртуализации **PROXMOX 8.3.1**  

### Конфигурация виртуальной машины
> Debian GNU/Linux 12 (bookworm)  
> CPU: x86-64-v2-AES  
> Sockets: 2  
> Memory: 1024  
> Hard disk 0: 32G  
> BIOS: SeaBIOS  
> Machine: i440fx  

### Разница между образом и контейнером:

**Образ (Image)** – это шаблон или "слепок" файловой системы, содержащий все необходимое для запуска приложения (ОС, зависимости, конфигурацию, исполняемые файлы). Он неизменяемый и может использоваться для создания множества контейнеров.  

**Контейнер (Container)** – это запущенный экземпляр образа. Контейнер имеет собственное файловое пространство, процессы и сетевую среду, но использует ядро хостовой ОС.

**Простая аналогия:**  
Образ — это чертеж (шаблон).  
Контейнер — это здание, построенное по этому чертежу.  

### Кастомный образ nginx

На базе **debian:bookworm-slim** создан [кастомный образ](https://github.com/Resovalko/Otus-Linux-Adm-Prof/blob/main/19-Docker%20Dockerfile/Dockerfile") **nginx**  

- web сервис работает на портах **https - 80** и **https - 5432**
- настроен редирект с **http** на **https**
- на **https** генерируется самоподписанный сертификат
- порт **https** возможно изменить
- при запуске отобразится страница с текстом **"Привет, я твой Docker контейнер!"**

#### Запуск
Запуск контейнера с кастомным образом:
```
docker run -p 80:80 -p 5432:5432 -d resovalko/my-nginx
```
Запуск контейнера с изменением порта SSL:
```
docker run -e SSL_PORT=8443 -p 80:80 -p 8443:8443 -d resovalko/my-nginx
```

### Можно ли в контейнере собрать ядро?

Да, в контейнере можно собрать ядро, но есть нюансы:  

Контейнер не управляет ядром – Docker использует ядро хостовой ОС, поэтому новое ядро, собранное внутри контейнера, не может быть загружено в работу без выхода за пределы контейнера.  

**Требования для сборки ядра:** 

- Установить зависимости (gcc, make, flex, bison, libssl-dev и т. д.).
- Скачать исходники ядра.
- Запустить процесс компиляции (make).
- Пример сборки ядра в контейнере:

```dockerfile
FROM debian:bookworm

# Устанавливаем необходимые пакеты для сборки ядра
RUN apt-get update && apt-get install -y \
    build-essential bc bison flex libssl-dev libelf-dev wget curl && \
    rm -rf /var/lib/apt/lists/*

# Устанавливаем рабочую директорию
WORKDIR /usr/src

# Загружаем исходники ядра
RUN curl -O https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.7.tar.xz && \
    tar -xf linux-6.7.tar.xz && \
    rm linux-6.7.tar.xz

# Переходим в папку с исходниками
WORKDIR /usr/src/linux-6.7

# Настраиваем конфигурацию ядра
RUN make defconfig

# Собираем ядро
RUN make -j$(nproc)

# Собираем модули
RUN make modules -j$(nproc)

# Упаковываем ядро в tar-архив
RUN tar -czvf /usr/src/linux-6.7-built.tar.gz /usr/src/linux-6.7

# Указываем конечный результат
CMD ["/bin/bash"]
```

Этот **Dockerfile**:
- Устанавливает все необходимые зависимости.
- Загружает исходный код ядра версии 6.7.
- Разархивирует и настраивает ядро.
- Собирает ядро и модули, используя make.
- Упаковывает собранное ядро в архив для дальнейшего использования.

Запуск сборки:
```
docker build -t kernel-builder .
docker run --rm -it kernel-builder
```
После завершения сборки архив с ядром (linux-6.7-built.tar.gz) можно извлечь с помощью **docker cp**.